<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>El Taller de Don Buenaventura 🔧</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- Estilos del Taller de Don Buenaventura --- */
  :root {
    --color-fondo: #1a1a1a;
    --color-panel: #2a2a2a;
    --color-borde: #444;
    --color-texto: #f5f5f5;
    --color-texto-muted: #999;
    --color-acento: #FFC107; /* Amarillo/Oro sugerido */
    --color-acento-oscuro: #e6a700;
    --color-rojo: #e74c3c;
    --color-verde: #2ecc71;
    --color-azul: #3498db;
    --radio-borde: 8px;
    --sombra: 0 4px 15px rgba(0, 0, 0, 0.5);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  html { scroll-behavior: smooth; }

  body {
    background-color: var(--color-fondo);
    color: var(--color-texto);
    line-height: 1.6;
    padding: 20px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    background-color: var(--color-panel);
    border-radius: var(--radio-borde);
    border: 1px solid var(--color-borde);
    box-shadow: var(--sombra);
    overflow: hidden;
  }

  /* --- Encabezado --- */
  header {
    display: flex;
    align-items: center;
    padding: 20px 30px;
    background-color: #111;
    border-bottom: 3px solid var(--color-acento);
  }
  header .icon-taller {
    font-size: 3.5rem;
    color: var(--color-acento);
    margin-right: 20px;
    transform: rotate(-10deg);
  }
  header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-texto);
  }
  header p {
    font-size: 1.1rem;
    color: var(--color-texto-muted);
    font-style: italic;
  }

  /* --- Pestañas de Navegación --- */
  .tabs-nav {
    display: flex;
    background-color: #222;
    border-bottom: 1px solid var(--color-borde);
  }
  .tab-button {
    padding: 15px 25px;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--color-texto-muted);
    font-size: 1.1rem;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    border-bottom: 3px solid transparent;
  }
  .tab-button:hover {
    background-color: var(--color-panel);
    color: var(--color-texto);
  }
  .tab-button.active {
    color: var(--color-acento);
    border-bottom: 3px solid var(--color-acento);
  }

  /* --- Contenido de las Pestañas --- */
  .tab-content {
    display: none;
    padding: 30px;
    animation: fadeIn 0.4s;
  }
  .tab-content.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- Estilos del Chatbot (Don Buenaventura) --- */
  #chat-window {
    display: flex;
    flex-direction: column;
    height: 70vh;
    max-height: 800px;
  }
  #chat-log {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid var(--color-borde);
    border-radius: var(--radio-borde);
    background-color: var(--color-fondo);
  }
  .chat-message {
    margin-bottom: 15px;
    display: flex;
  }
  .chat-message .icon {
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
  }
  .chat-message .text-bubble {
    padding: 15px;
    border-radius: var(--radio-borde);
    max-width: 80%;
  }
  
  /* Mensaje del Usuario */
  .chat-message.user {
    justify-content: flex-end;
  }
  .chat-message.user .icon {
    background-color: var(--color-azul);
    color: white;
    margin-right: 0;
    margin-left: 15px;
  }
  .chat-message.user .text-bubble {
    background-color: var(--color-azul);
    color: white;
    border-bottom-right-radius: 0;
  }
  
  /* Mensaje del Bot (Don Buenaventura) */
  .chat-message.bot .icon {
    background-color: var(--color-acento);
    color: #111;
  }
  .chat-message.bot .text-bubble {
    background-color: #333;
    border: 1px solid var(--color-borde);
    border-bottom-left-radius: 0;
  }
  .chat-message.bot .text-bubble strong {
    color: var(--color-acento);
  }

  #chat-input-form {
    display: flex;
    margin-top: 20px;
  }
  #chat-input {
    flex-grow: 1;
    padding: 15px;
    border: 1px solid var(--color-borde);
    border-radius: var(--radio-borde) 0 0 var(--radio-borde);
    background-color: #333;
    color: var(--color-texto);
    font-size: 1.1rem;
    outline: none;
  }
  #chat-input:focus {
    border-color: var(--color-acento);
    box-shadow: 0 0 8px var(--color-acento);
  }
  #chat-submit {
    padding: 0 25px;
    font-size: 1.1rem;
    font-weight: 600;
    background-color: var(--color-acento);
    color: var(--color-fondo);
    border: none;
    border-radius: 0 var(--radio-borde) var(--radio-borde) 0;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  #chat-submit:hover {
    background-color: var(--color-acento-oscuro);
  }
  
  /* --- Estilos del Manual (Reutilizados de tu gemini.txt) --- */
  #manual-window h2 {
    color: var(--color-acento);
    margin-bottom: 25px;
    border-bottom: 2px solid var(--color-borde);
    padding-bottom: 12px;
    font-size: 1.8rem;
    display: flex;
    align-items: center;
  }
  #manual-window h2 i, #manual-window h2 span {
    margin-right: 15px;
    font-size: 1.6rem;
  }
  
  .selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .selection-card {
    background: #f5f5f5;
    color: #333;
    padding: 20px;
    border-radius: var(--radio-borde);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    text-align: center;
    border: 2px solid var(--color-borde);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  .selection-card:hover {
    transform: translateY(-5px);
    border-color: var(--color-acento);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  .selection-card .icon {
    font-size: 3rem;
    margin-bottom: 12px;
    line-height: 1;
    color: var(--color-panel);
  }
  .selection-card strong {
    font-size: 1.2rem;
    font-weight: 600;
    color: #111;
  }
  .selection-card .description {
    font-size: 0.9rem;
    color: #555;
    margin-top: 5px;
  }

  .failures-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
  }
  .failure-btn {
    background: #333;
    color: var(--color-texto);
    padding: 15px;
    border-radius: var(--radio-borde);
    border: 1px solid var(--color-borde);
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
  }
  .failure-btn:hover {
    background-color: #444;
    border-color: var(--color-acento);
  }
  .failure-btn strong {
    color: var(--color-acento);
    font-size: 1.1rem;
    margin-bottom: 5px;
  }
  .failure-btn .initial-context {
    font-size: 0.9rem;
    color: var(--color-texto-muted);
    font-style: italic;
  }
  .failure-btn .models {
    font-size: 0.8rem;
    color: #777;
    margin-top: 5px;
  }
  
  .filter-controls {
    margin-bottom: 20px;
  }
  #filterInput {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--color-borde);
    border-radius: var(--radio-borde);
    background-color: #333;
    color: var(--color-texto);
    font-size: 1rem;
  }
  
  .info-card {
    background: #333;
    padding: 20px;
    border-radius: var(--radio-borde);
    margin-bottom: 20px;
    border-left: 5px solid var(--color-acento);
  }
  .info-card h4 {
    color: var(--color-acento);
    margin-bottom: 12px;
    font-size: 1.3rem;
  }
  .info-card ul, .info-card ol {
    margin-left: 20px;
    padding-left: 10px;
  }
  .info-card li { margin-bottom: 8px; }
  .info-card code {
    background: var(--color-fondo);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: Consolas, 'Courier New', monospace;
  }
  .alert-safety {
    border-left-color: var(--color-rojo);
    background-color: rgba(231, 76, 60, 0.1);
  }
  .alert-safety h4 { color: var(--color-rojo); }
  
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
  }
  .search-btn {
    background: var(--color-acento);
    color: var(--color-fondo);
    padding: 10px 20px;
    border-radius: var(--radio-borde);
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 600;
  }
  /* Botón especial para el chat */
  .chat-message .search-btn {
    font-size: 0.9rem;
    padding: 8px 15px;
  }
  .search-btn:hover { background: var(--color-acento-oscuro); }
  .reset-btn { background: #555; color: white; }
  .reset-btn:hover { background: #777; }
  .hidden { display: none; }

  /* --- Estilos de la Biblioteca --- */
  #biblioteca-window .video-list, #biblioteca-window .forum-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }
  #biblioteca-window .resource-card {
    background: #333;
    border: 1px solid var(--color-borde);
    border-radius: var(--radio-borde);
    overflow: hidden;
    transition: all 0.2s;
  }
  #biblioteca-window .resource-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    border-color: var(--color-acento);
  }
  #biblioteca-window .resource-card-content {
    padding: 15px;
  }
  #biblioteca-window .resource-card-content h4 {
    color: var(--color-acento);
    margin-bottom: 10px;
    font-size: 1.1rem;
  }
  #biblioteca-window .resource-card-content p {
    color: var(--color-texto-muted);
    font-size: 0.9rem;
    margin-bottom: 15px;
  }
  #biblioteca-window .resource-card-content a {
    color: var(--color-azul);
    text-decoration: none;
    font-weight: 600;
  }
  #biblioteca-window .resource-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-bottom: 1px solid var(--color-borde);
  }
  
  /* --- Responsividad para teléfonos --- */
  @media (max-width: 768px) {
    body {
        padding: 5px;
    }
    .container {
        padding: 0;
        border: none;
        border-radius: 0;
    }
    header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 15px;
    }
    header .icon-taller {
        margin-right: 0;
        margin-bottom: 10px;
    }
    header h1 { font-size: 2rem; }
    header p { font-size: 1rem; }
    
    .tabs-nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    .tab-button {
        font-size: 0.9rem;
        padding: 12px 10px;
        flex-grow: 1;
        text-align: center;
    }
    
    .tab-content {
        padding: 15px;
    }
    
    #chat-window {
        height: 75vh; /* Más altura en móvil */
    }
    
    .selection-grid, .failures-list, #biblioteca-window .video-list, #biblioteca-window .forum-list {
        grid-template-columns: 1fr; /* Una sola columna */
        gap: 15px;
    }
    
    #manual-window h2 {
        font-size: 1.5rem;
    }
    .selection-card {
        min-height: 120px;
        padding: 15px;
    }
    .selection-card .icon {
        font-size: 2.5rem;
    }
    .selection-card strong {
        font-size: 1.1rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    .search-btn {
        width: 100%;
        text-align: center;
        justify-content: center;
    }
  }
</style>
</head>
<body>

  <div class="container">
    <header>
      <div class="icon-taller">🔧</div>
      <div>
        <h1>El Taller de Don Buenaventura</h1>
        <p>"Las máquinas hablan, compadre. El truco está en saber escucharlas."</p>
      </div>
    </header>

    <nav class="tabs-nav">
      <button class="tab-button active" data-tab="chat"><i class="fas fa-comments"></i> Habla con Don B.</button>
      <button class="tab-button" data-tab="manual"><i class="fas fa-book-open"></i> El Manual del Taller</button>
      <button class="tab-button" data-tab="biblioteca"><i class="fas fa-video"></i> Biblioteca (Videos y Foros)</button>
    </nav>

    <div id="chat-tab" class="tab-content active">
      <div id="chat-window">
        <div id="chat-log">
          <div class="chat-message bot">
            <div class="icon">B</div>
            <div class="text-bubble">
              <p>¡Quiubo, parcero! Soy Don Buenaventura. Llevo 40 años metido entre fierros, desde Cali hasta la mina.</p>
              <p>Tengo toda la información de esos manuales que subiste y la experiencia del taller. ¿En qué lo puedo ayudar? Écheme el cuento.</p>
            </div>
          </div>
        </div>
        <form id="chat-input-form">
          <input type="text" id="chat-input" placeholder="Escriba su pregunta (ej: 'humo negro', 'no parte')..." autocomplete="off">
          <button type="submit" id="chat-submit"><i class="fas fa-paper-plane"></i> Enviar</button>
        </form>
      </div>
    </div>

    <div id="manual-tab" class="tab-content">
      <div id="manual-window">
        <section id="machineTypeSection" class="section">
          <h2><span class="section-icon">⚙️</span> Paso 1: Seleccione el tipo de maquinaria</h2>
          <div id="machineTypesGrid" class="selection-grid"></div>
        </section>

        <section id="brandModelSection" class="section hidden">
          <h2><i class="fas fa-tags section-icon"></i> Paso 2: Seleccione la Marca/Modelo</h2>
          <button id="backToTypesBtn" class="search-btn reset-btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Volver a Tipos</button>
          <div id="brandsGrid" class="selection-grid"></div>
        </section>

        <section id="failureSection" class="section hidden">
          <h2><i class="fas fa-search section-icon"></i> Paso 3: Seleccione una avería (o filtra)</h2>
          <button id="backToBrandsBtn" class="search-btn reset-btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Volver a Marcas</button>
          <div class="filter-controls">
            <input type="text" id="filterInput" placeholder="Escribe para filtrar fallas (ej: 'inyector', 'hidraulico', 'freno')...">
          </div>
          <div id="failuresList" class="failures-list"></div>
        </section>

        <section id="diagnosisArea" class="section hidden">
          <button id="backToFailuresBtn" class="search-btn reset-btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Volver a Fallas</button>
          <h2 id="diagnosisTitle"><i class="fas fa-clipboard-list section-icon"></i> Diagnóstico Detallado</h2>
          <div id="diagnosisResult"></div>
          <div class="action-buttons">
            <a id="btnOpenGoogleDiag" class="search-btn" href="#" target="_blank"><i class="fab fa-google"></i> Buscar Falla en Google</a>
            <button id="btnReset" class="search-btn reset-btn"><i class="fas fa-undo"></i> Reiniciar Manual</button>
          </div>
        </section>
      </div>
    </div>

    <div id="biblioteca-tab" class="tab-content">
      <h2><i class="fas fa-video"></i> Biblioteca: Videos del Taller</h2>
      <div id="video-list" class="video-list">
        </div>
      <h2 style="margin-top: 40px;"><i class="fas fa-comments"></i> Foros y Experiencias Reales</h2>
      <div id="forum-list" class="forum-list">
        </div>
    </div>

  </div>

<script>
/* ========================================================================= */
/* JS DE "EL TALLER DE DON BUENAVENTURA" (v2.0 - Búsqueda Inteligente)     */
/* Fusiona la BD de Preguntas (Don_Piston_Edicion_Taller_Real.txt)           */
/* con la BD del Manual (gemini.txt + a.txt)                                 */
/* y los enlaces de la Biblioteca (Don_Piston_Proyecto.txt)                  */
/* ========================================================================= */

// --- BASE DE DATOS 1: CHATBOT (De Don_Piston_Edicion_Taller_Real.txt) ---
const db_preguntas_respuestas = [
  {"categoria": "Motor", "pregunta": "Mi Hilux echa humo negro al acelerar fuerte", "respuesta": "Eso, compadre, es exceso de combustible o poco aire. Fíjate en el filtro de aire, puede estar tapao’ con polvo. También revisá los inyectores, a veces uno gotea y ensucia el humo. Si viene de la cordillera, ni lo pensés: ese filtro debe estar más saturado que tubo de escape viejo.", "keywords": ["hilux", "humo negro", "acelerar", "potencia", "inyector"]},
  {"categoria": "Motor", "pregunta": "El motor suena como cascabeleo en ralentí", "respuesta": "Ah, ese cascabeleo puede ser el tiempo adelantao’ o gasolina de mala calidad. En los diésel puede ser juego en biela o taqué pegado. Echale oído, parcero: si el sonido va con las RPM, son metales. Si no, puede ser válvula floja.", "keywords": ["cascabeleo", "ralentí", "ruido", "biela", "taqué", "motor suena"]},
  {"categoria": "Motor", "pregunta": "Mi camión pierde fuerza en subida", "respuesta": "Puede ser filtro de combustible sucio o turbo flojo. Revisá que el turbo no esté con juego, que gire suavecito. Si el camión ha trabajado en altura, ajustá el aire y el diésel, que allá el oxígeno no alcanza, viejo.", "keywords": ["pierde fuerza", "subida", "camion", "turbo", "filtro combustible", "altura"]},
  {"categoria": "Motor", "pregunta": "La camioneta se calienta rápido", "respuesta": "Eso puede ser termostato pegado o radiador tapado. Si el líquido se pone marrón, hay óxido. Cambiale el refrigerante y revisá que el ventilador entre a tiempo. En zonas costeras, el salitre jode los radiadores por dentro.", "keywords": ["calienta", "recalentamiento", "termostato", "radiador", "refrigerante", "costa"]},
  {"categoria": "Motor", "pregunta": "El auto tiembla en ralentí", "respuesta": "Puede ser bujía fallando o soporte de motor cortao’. Sacá bujías, revisá el color. Si están negras, está rico en mezcla. Si están blancas, muy pobre. Ajustá mezcla o inyectores.", "keywords": ["tiembla", "ralentí", "bujía", "soporte motor", "mezcla"]},
  {"categoria": "Transmisión", "pregunta": "Mi caja automática pega tirones", "respuesta": "Eso pasa cuando el aceite de caja (ATF) está viejo o bajo. Sacá la varilla y mirá el color: si está oscuro o huele a quemao’, cambio urgente. No le sigas metiendo pata, que se te va el cuerpo de válvulas.", "keywords": ["caja automatica", "tirones", "golpea", "atf", "aceite caja", "cuerpo de valvulas"]},
  {"categoria": "Transmisión", "pregunta": "La caja manual raspa al meter segunda", "respuesta": "Sincronizador gastao’, compa. También puede ser que el embrague no esté desacoplando bien. Purgá el sistema y revisá el nivel del hidráulico.", "keywords": ["caja manual", "raspa", "segunda", "sincronizador", "embrague"]},
  {"categoria": "Transmisión", "pregunta": "Mi camioneta zumba en alta", "respuesta": "Ese zumbido suele ser rodamiento de diferencial o caja. Revisá el nivel del aceite, porque si anda seco, te deja varao’. Y en la costa, ese aceite se contamina fácil con humedad.", "keywords": ["zumba", "zumbido", "alta velocidad", "diferencial", "rodamiento"]},
  {"categoria": "Transmisión", "pregunta": "El embrague está muy duro", "respuesta": "Podría ser cable reseco, prensa vieja o aire en el sistema hidráulico. Si es maquinaria pesada, ojo que a veces los bombines se pegan por polvo.", "keywords": ["embrague duro", "clutch", "prensa", "bombin"]},
  {"categoria": "Transmisión", "pregunta": "No entran las marchas en frío", "respuesta": "Puede ser el aceite muy espeso o el varillaje seco. Echale un 75W-90 y lubricá los puntos del varillaje. A la vieja escuela: un poquito de grasa blanca y santo remedio.", "keywords": ["no entran cambios", "marchas", "frio", "aceite caja", "75w-90"]},
  {"categoria": "Eléctrico", "pregunta": "Mi auto no parte y la batería está nueva", "respuesta": "Revisá los bornes, parce. A veces están sulfatados o flojos. Limpiá con bicarbonato y ajustá bien. También puede ser el relé de arranque o el motor de partida pegado.", "keywords": ["no parte", "no arranca", "bateria nueva", "bornes", "sulfatado", "motor de partida"]},
  {"categoria": "Eléctrico", "pregunta": "Las luces bajan de intensidad al acelerar", "respuesta": "Eso es alternador flojo o correa resbalando. Revisá tensión de correa y borne del alternador. Si el voltaje baja de 13V, ya sabés: alternador al taller.", "keywords": ["luces bajan", "intensidad", "acelerar", "alternador", "correa"]},
  {"categoria": "Eléctrico", "pregunta": "Mi camión prende el check engine", "respuesta": "Sacá el scanner, hermano. Si marca P0401, es EGR tapada. Si es P0101, sensor MAF sucio. Limpialo con spray especial, no le metas aire a presión o lo quemás.", "keywords": ["check engine", "luz motor", "p0401", "egr", "p0101", "maf"]},
  {"categoria": "Eléctrico", "pregunta": "El limpia parabrisas no funciona", "respuesta": "Fusible o motor quemao’. Revisá fusible con lámpara de prueba, no a ojo. Si el motor hace clic y no gira, está trabado. A veces con un golpecito suave revive.", "keywords": ["limpiaparabrisas", "no funciona", "fusible", "motor quemado"]},
  {"categoria": "Eléctrico", "pregunta": "No cargan los vidrios eléctricos", "respuesta": "Interruptor sucio o motor cansao’. Levantá el tapiz, echale limpia contactos. Si sigue igual, toca abrir el motorcito, limpiar carbones y engrasar engranajes.", "keywords": ["vidrios electricos", "no sube", "no baja", "interruptor"]},
  {"categoria": "Frenos", "pregunta": "El pedal se va al fondo", "respuesta": "Aire en el sistema o cilindro maestro frito. Purgá con calma, empezando por la rueda más lejana. Si sigue, cilindro maestro nuevo. No se juega con los frenos, compa.", "keywords": ["pedal al fondo", "freno esponjoso", "aire", "purgar", "cilindro maestro"]},
  {"categoria": "Frenos", "pregunta": "Suena chillido al frenar", "respuesta": "Pastillas gastadas o mal asentadas. Sacá la rueda, echale pasta antifricción detrás de la pastilla. Si el disco está rayado, mandalo a rectificar.", "keywords": ["chillido", "ruido frenar", "pastillas", "disco rayado"]},
  {"categoria": "Frenos", "pregunta": "El camión frena en un solo lado", "respuesta": "Caliper trabado o manguera colapsada. Revisá el pistón del caliper, limpialo y aplicale grasa especial. En vehículos de faena, eso es clásico del polvo fino.", "keywords": ["frena chueco", "frena un lado", "caliper", "manguera colapsada"]},
  {"categoria": "Frenos", "pregunta": "Se calientan los frenos rápido", "respuesta": "Frenás con el pie encima, viejo. Dejá respirar el sistema. También puede ser válvula de retorno tapada o zapata rozando. Revisá ajuste.", "keywords": ["frenos calientes", "sobrecalentamiento", "zapata", "freno de mano"]},
  {"categoria": "Frenos", "pregunta": "La camioneta vibra al frenar", "respuesta": "Discos ovalados o bujes flojos. Rectificá discos y revisá bujes. No siempre es el disco, a veces es la suspensión que juega.", "keywords": ["vibra al frenar", "vibracion", "discos ovalados", "bujes"]},
  {"categoria": "Suspensión", "pregunta": "Siento un golpe seco al pasar baches", "respuesta": "Bieleta o amortiguador reventao’. Revisá que no tenga fuga de aceite. Si chorrea, cámbialo. No hay arreglo casero ahí.", "keywords": ["golpe seco", "bache", "bieleta", "amortiguador"]},
  {"categoria": "Suspensión", "pregunta": "El auto se va pa’ un lado", "respuesta": "Alineación mala o presión desigual en neumáticos. Revisá también terminales. En caminos de tierra, eso se desajusta más que promesa de político.", "keywords": ["se va para un lado", "tira", "alineacion", "neumaticos"]},
  {"categoria": "Suspensión", "pregunta": "Escucho crujido al girar", "respuesta": "Puede ser homocinética seca o rodamiento. Revisá guardapolvos. Si están rotos, el polvo ya hizo daño. Cambialos antes que truene.", "keywords": ["crujido", "girar", "homocinetica", "rodamiento"]},
  {"categoria": "Suspensión", "pregunta": "El camión rebota mucho", "respuesta": "Amortiguadores muertos. Si salta como cabro chico en cama elástica, no hay vuelta: se cambian los cuatro y listo.", "keywords": ["rebota", "amortiguadores muertos", "suspension"]},
  {"categoria": "Suspensión", "pregunta": "El volante vibra a 90 km/h", "respuesta": "Balanceo, viejo. O llanta doblada. Si vibra solo al frenar, revisá discos. Si vibra siempre, balanceo o rodamiento.", "keywords": ["volante vibra", "90 km/h", "balanceo", "llanta doblada"]},
  {"categoria": "Maquinaria Pesada", "pregunta": "La retroexcavadora pierde presión hidráulica", "respuesta": "Filtro hidráulico tapao’ o bomba cansada. Revisá fugas externas y escuchá si la bomba chilla. Si el aceite huele a quemao’, cámbialo ya.", "keywords": ["retroexcavadora", "presion hidraulica", "bomba cansada", "filtro hidraulico"]},
  {"categoria": "Maquinaria Pesada", "pregunta": "El cargador frontal levanta lento", "respuesta": "Puede ser válvula de alivio trabada o aceite viejo. Cambialo y purgá el sistema. Si sigue, revisá el carrete de la válvula, puede estar pegado.", "keywords": ["cargador frontal", "levanta lento", "valvula de alivio", "aceite viejo"]},
  {"categoria": "Maquinaria Pesada", "pregunta": "El camión minero calienta mucho en faena", "respuesta": "Radiador sucio, polvo del desierto tapando las aletas. Sacá presión con aire, con cuidado, y lavalo con detergente neutro. Revisá también ventilador viscoso.", "keywords": ["camion minero", "calienta", "faena", "radiador sucio", "polvo", "desierto"]},
  {"categoria": "Maquinaria Pesada", "pregunta": "Retro con movimiento errático", "respuesta": "Aceite con agua o válvulas sucias. Cambia aceite y filtro, purgá el sistema. Si sigue, bomba hidráulica con desgaste interno.", "keywords": ["retroexcavadora", "movimiento erratico", "aceite con agua", "valvulas sucias"]},
  {"categoria": "Maquinaria Pesada", "pregunta": "Bulldozer con humo azul", "respuesta": "Eso es aceite quemándose, viejo. Segmentos gastados o válvulas chupando aceite. Requiere abrir motor, no hay magia ahí. Asegurate de usar buen aceite 15W-40.", "keywords": ["bulldozer", "humo azul", "quema aceite", "segmentos", "anillos"]}
];

// --- BASE DE DATOS 2: ESCENARIOS GENERALES (Nueva) ---
// (Plantillas para preguntas comunes que no están en la DB de "Taller Real")
const generalScenarioTemplates = {
    "motor_con_agua": (machineName) => ({
        id: `gen_agua`,
        name: `Ingreso de Agua al Motor (${machineName})`,
        initial: `Detectado posible ingreso de agua (refrigerante o externa) al sistema de combustión o lubricación.`,
        alertaSeguridad: "¡NO INTENTE ARRANCAR EL MOTOR! Riesgo de daño catastrófico (hydro lock o 'bloqueo hidráulico'). Detener inmediatamente si estaba en marcha.",
        symptoms: [
            "Humo blanco excesivo y denso por el escape (vapor de agua).",
            "El motor no gira o se bloquea al intentar arrancar (hydro lock).",
            "Nivel de refrigerante bajo sin fugas externas visibles.",
            "Nivel de aceite sube y/o aceite con apariencia lechosa/grisácea (como 'café con leche').",
            "Sobrecalentamiento del motor.",
            "Pérdida súbita de potencia si ocurre en marcha.",
            "Burbujas en el radiador o depósito de expansión."
        ],
        causes: [
            "Falla de la junta de culata (empaquetadura).",
            "Culata (cabeza del motor) fisurada o deformada.",
            "Bloque del motor fisurado.",
            "Falla del enfriador de aceite (si es enfriado por agua).",
            "Falla del enfriador de EGR (si es enfriado por agua).",
            "Ingreso de agua por la admisión (ej. cruce de ríos profundos, lavado a presión incorrecto)."
        ],
        solution: [
            "Drenar TODO el aceite y refrigerante contaminados.",
            "Identificar y reparar la causa raíz (reemplazo de junta, reparación/reemplazo de culata/bloque, reemplazo de enfriador).",
            "Limpiar internamente el motor si hubo hydro lock o contaminación severa.",
            "Reemplazar filtros de aceite.",
            "Llenar con aceite y refrigerante nuevos según especificación.",
            "Purgar sistema de enfriamiento.",
            "Realizar pruebas de funcionamiento y monitorear niveles."
        ]
    })
};


// --- BASE DE DATOS 3: MANUAL TÉCNICO (De gemini.txt + a.txt) ---
const machineTypes = {
    camioneta: { name: "Camioneta Minera", icon: "🛻", description: "Hilux, Ranger, F-150..." },
    retroexcavadora: { name: "Retroexcavadora", icon: "🚜", description: "Komatsu, CAT, JD, JCB..." },
    excavadora: { name: "Excavadora", icon: "<i class='fas fa-mountain-city'></i>", description: "CAT, Komatsu, Volvo, Hitachi..." },
    cargador: { name: "Cargador Frontal", icon: "<i class='fas fa-cubes-stacked'></i>", description: "CAT, Komatsu, Volvo, Kawasaki..." },
    dumper: { name: "Camión Minero", icon: "<i class='fas fa-truck-monster'></i>", description: "CAT, Komatsu, Belaz, Volvo..." },
    bulldozer: { name: "Bulldozer", icon: "<i class='fas fa-tractor'></i>", description: "CAT, Komatsu, Liebherr..." },
    motoniveladora: { name: "Motoniveladora", icon: "<i class='fas fa-road'></i>", description: "CAT, Komatsu, JD..." },
    pala: { name: "Pala Hidráulica/Eléctrica", icon: "<i class='fas fa-person-digging'></i>", description: "CAT, Komatsu, Liebherr, Bucyrus..." },
    perforadora: { name: "Perforadora Rotativa", icon: "<i class='fas fa-bore-hole'></i>", description: "Sandvik, Atlas Copco..." },
    compactador: { name: "Compactador Vibratorio", icon: "<i class='fas fa-road-roller'></i>", description: "BOMAG, CAT, Hamm..." },
    tbm: { name: "Tuneladora (TBM)", icon: "<i class='fas fa-train-tunnel'></i>", description: "Herrenknecht..." },
    dragalina: { name: "Dragalina", icon: "<i class='fas fa-ship'></i>", description: "Bucyrus..." },
    spreader: { name: "Spreader (Extensor)", icon: "<i class='fas fa-truck-loading'></i>", description: "TAKRAF..." },
    reclaimer: { name: "Reclaimer (Recuperador)", icon: "<i class='fas fa-recycle'></i>", description: "Sandvik..." },
    shiploader: { name: "Ship Loader (Cargador Barcos)", icon: "<i class='fas fa-anchor'></i>", description: "Siemens..." },
    harvester: { name: "Harvester (Forestal)", icon: "<i class='fas fa-tree'></i>", description: "John Deere..." },
    forwarder: { name: "Forwarder (Forestal)", icon: "<i class='fas fa-truck-pickup'></i>", description: "Caterpillar..." },
    cisterna: { name: "Camión Cisterna", icon: "<i class='fas fa-gas-pump'></i>", description: "Mercedes, Volvo, Scania..." },
    zanjadora: { name: "Zanjadora", icon: "<i class='fas fa-mound'></i>", description: "Vermeer, Trencor..." },
    planta_asfalto: { name: "Planta de Asfalto", icon: "<i class='fas fa-industry'></i>", description: "Marini, Astec..." },
    compresor: { name: "Compresor de Aire", icon: "<i class='fas fa-compress'></i>", description: "Atlas Copco, IR..." },
    generador: { name: "Generador Diesel", icon: "<i class='fas fa-bolt'></i>", description: "CAT, Cummins..." },
    diagnostico: { name: "Métodos Diagnóstico", icon: "<i class='fas fa-stethoscope'></i>", description:"Vibraciones, Aceite, Termografía..."}
};

const brandsAndModels = {
    // (Datos de brandsAndModels de gemini.txt)
    camioneta: [
        { key: "hilux", name: "Toyota Hilux", icon: "🛻", models: ["2.4L", "2.8L Diesel"] },
        { key: "ranger", name: "Ford Ranger", icon: "🛻", models: ["3.2L", "2.0L Bi-Turbo"] },
        { key: "l200", name: "Mitsubishi L200", icon: "🛻", models: ["2.4L MIVEC"] },
        { key: "np300", name: "Nissan NP300/Navara", icon: "🛻", models: ["2.3L Bi-Turbo"] },
        { key: "amarok", name: "Volkswagen Amarok", icon: "🛻", models: ["2.0L TDI", "3.0L V6 TDI"] },
        { key: "f150", name: "Ford F-150 Raptor", icon: "🛻", models: ["3.5L Ecoboost"] },
        { key: "ram1500", name: "RAM 1500", icon: "🛻", models: ["3.0L Ecodiesel"] },
    ],
    retroexcavadora: [
        { key: "komatsu_wb", name: "Komatsu WB93/97", icon: "🚜", models: ["WB93R-5", "WB97"] },
        { key: "cat_retro", name: "CAT 416-450", icon: "🚜", models: ["416E", "420F", "430F", "446", "450"] },
        { key: "jcb_3cx", name: "JCB 3CX/4CX", icon: "🚜", models: ["3CX", "4CX"] },
        { key: "case_580", name: "Case 580/590", icon: "🚜", models: ["580N", "590SN"] },
        { key: "jd_retro", name: "John Deere", icon: "🚜", models: ["310SL", "310L"] },
    ],
    excavadora: [
        { key: "cat_exc", name: "CAT 320/336", icon: "<i class='fas fa-mountain-city'></i>", models: ["320D", "320E", "320F", "336F/GC"] },
        { key: "komatsu_exc", name: "Komatsu PC200/300", icon: "<i class='fas fa-mountain-city'></i>", models: ["PC200-8", "PC210LC-10", "PC300-8"] },
        { key: "hitachi_exc", name: "Hitachi ZX200/350/470", icon: "<i class='fas fa-mountain-city'></i>", models: ["ZX200-5G", "ZX350", "ZX470"] },
        { key: "volvo_exc", name: "Volvo EC210/220/240", icon: "<i class='fas fa-mountain-city'></i>", models: ["EC210B", "EC220D", "EC240C"] },
        { key: "doosan_exc", name: "Doosan", icon: "<i class='fas fa-mountain-city'></i>", models: ["DX300", "DX500"] },
    ],
     cargador: [
        { key: "cat_loader", name: "CAT 950-994", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["950H", "966H", "972H", "994K"] },
        { key: "komatsu_loader", name: "Komatsu WA Series", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["WA380-6", "WA900", "WA1200"] },
        { key: "volvo_loader", name: "Volvo L120-L350", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["L120F", "L150G", "L350H"] },
        { key: "liebherr_loader", name: "Liebherr L586", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["L586 XPower"] },
        { key: "kawasaki_loader", name: "Kawasaki", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["85Z", "95Z"] },
        { key: "hyundai_loader", name: "Hyundai HL", icon: "<i class='fas fa-cubes-stacked'></i>", models: ["HL850", "HL960"] },
    ],
     dumper: [
         { key: "cat_dumper", name: "CAT Dumper", icon: "<i class='fas fa-truck-monster'></i>", models: ["777D/F", "785D", "793F", "797F (Mecánico)", "740B (Articulado)"] },
         { key: "komatsu_dumper", name: "Komatsu Dumper", icon: "<i class='fas fa-charging-station'></i>", models: ["HD785-7 (Mecánico)", "930E", "980E (Eléctrico)"] },
         { key: "volvo_dumper", name: "Volvo Dumper", icon: "<i class='fas fa-truck-moving'></i>", models: ["A40G (Articulado)"] },
         { key: "liebherr_dumper", name: "Liebherr Dumper", icon: "<i class='fas fa-charging-station'></i>", models: ["T284 (Eléctrico)"] },
         { key: "belaz_dumper", name: "Belaz Dumper", icon: "<i class='fas fa-truck-monster'></i>", models: ["7530", "7560", "75710"] },
     ],
     bulldozer: [
        { key: "cat_dozer", name: "CAT D9/D11", icon: "<i class='fas fa-tractor'></i>", models: ["D9T", "D11T", "D11R"] },
        { key: "komatsu_dozer", name: "Komatsu D275/D475", icon: "<i class='fas fa-tractor'></i>", models: ["D275A", "D475A"] },
        { key: "liebherr_dozer", name: "Liebherr PR776", icon: "<i class='fas fa-tractor'></i>", models: ["PR776 (Hidrostático)"] },
     ],
     motoniveladora: [
         { key: "cat_grader", name: "CAT 16M/24M/140M3", icon: "<i class='fas fa-road'></i>", models: ["16M", "24M", "140M3"] },
         { key: "komatsu_grader", name: "Komatsu GD955", icon: "<i class='fas fa-road'></i>", models: ["GD955"] },
         { key: "jd_grader", name: "John Deere Grader", icon: "<i class='fas fa-road'></i>", models: ["872GP"] },
     ],
     pala: [
        { key: "cat_shovel", name: "CAT 6060/6090", icon: "<i class='fas fa-person-digging'></i>", models: ["6060FS", "6090FS"] },
        { key: "komatsu_shovel", name: "Komatsu PC8000", icon: "<i class='fas fa-person-digging'></i>", models: ["PC8000-6", "PC8000-11"] },
        { key: "liebherr_shovel", name: "Liebherr R9800", icon: "<i class='fas fa-person-digging'></i>", models: ["R9800"] },
        { key: "hitachi_shovel", name: "Hitachi EX5600/EX8000", icon: "<i class='fas fa-person-digging'></i>", models: ["EX5600-7", "EX8000-6"] },
        { key: "bucyrus_shovel", name: "Bucyrus Electric Shovel", icon: "<i class='fas fa-plug-circle-bolt'></i>", models: ["495HR"] },
     ],
     perforadora: [ { key: "sandvik_drill", name: "Sandvik Drill", icon: "<i class='fas fa-bore-hole'></i>", models: ["DX800"] }, { key: "atlas_drill", name: "Atlas Copco Drill", icon: "<i class='fas fa-bore-hole'></i>", models: ["ROC L8"] } ],
     compactador: [ { key: "bomag_compactor", name: "BOMAG Compactor", icon: "<i class='fas fa-road-roller'></i>", models: ["BW211D-50", "BW226DH-5"] }, { key: "cat_compactor", name: "CAT Compactor", icon: "<i class='fas fa-road-roller'></i>", models: ["CS74B"] }, { key: "hamm_compactor", name: "Hamm Compactor", icon: "<i class='fas fa-road-roller'></i>", models: ["HD14VV"] } ],
     tbm: [ { key: "herrenknecht_tbm", name: "Herrenknecht TBM", icon: "<i class='fas fa-train-tunnel'></i>", models: ["EPB Series"] } ],
     dragalina: [ { key: "bucyrus_dragline", name: "Bucyrus Dragline", icon: "<i class='fas fa-ship'></i>", models: ["495HR"] } ],
     spreader: [ { key: "takraf_spreader", name: "TAKRAF Spreader", icon: "<i class='fas fa-truck-loading'></i>", models: ["SRs Series"] } ],
     reclaimer: [ { key: "sandvik_reclaimer", name: "Sandvik Reclaimer", icon: "<i class='fas fa-recycle'></i>", models: ["RR1440"] } ],
     shiploader: [ { key: "siemens_shiploader", name: "Siemens Ship Loader", icon: "<i class='fas fa-anchor'></i>", models: ["Portalink"] } ],
     harvester: [ { key: "jd_harvester", name: "John Deere Harvester", icon: "<i class='fas fa-tree'></i>", models: ["1270G"] } ],
     forwarder: [ { key: "cat_forwarder", name: "CAT Forwarder", icon: "<i class='fas fa-truck-pickup'></i>", models: ["545"] } ],
     cisterna: [ { key: "mb_cisterna", name: "Mercedes-Benz Cisterna", icon: "<i class='fas fa-gas-pump'></i>", models: ["Actros 3346"] }, { key: "volvo_cisterna", name: "Volvo Cisterna", icon: "<i class='fas fa-gas-pump'></i>", models: ["FH 540"] }, { key: "scania_cisterna", name: "Scania Cisterna", icon: "<i class='fas fa-gas-pump'></i>", models: ["R 450"] } ],
     zanjadora: [ { key: "vermeer_trencher", name: "Vermeer Trencher", icon: "<i class='fas fa-mound'></i>", models: ["T655"] }, { key: "trencor_trencher", name: "Trencor Trencher", icon: "<i class='fas fa-mound'></i>", models: ["1660"] } ],
     planta_asfalto: [ { key: "marini_asphalt", name: "Marini Asphalt Plant", icon: "<i class='fas fa-industry'></i>", models: ["MP 176"] }, { key: "astec_asphalt", name: "Astec Asphalt Plant", icon: "<i class='fas fa-industry'></i>", models: ["Six Pack"] } ],
     compresor: [ { key: "atlas_compressor", name: "Atlas Copco Compressor", icon: "<i class='fas fa-compress'></i>", models: ["XAS 185"] }, { key: "ir_compressor", name: "Ingersoll Rand Compressor", icon: "<i class='fas fa-compress'></i>", models: ["XP825"] } ],
     generador: [ { key: "cat_gen", name: "CAT Generator", icon: "<i class='fas fa-bolt'></i>", models: ["3516B"] }, { key: "cummins_gen", name: "Cummins Generator", icon: "<i class='fas fa-bolt'></i>", models: ["QSK60 Series"] } ],
     diagnostico: [{ key: "diagnostico_avanzado", name: "Métodos de Análisis", models: ["Vibraciones", "Termografía", "Análisis Aceite"] }],
};

const failures = {
    // (TODA la base de datos de 'failures' de gemini.txt va aquí)
    // (Es la misma base de datos masiva de la v16 que ya validamos)
    hilux: [
        { id: 101, name: "Sistema Inyección Diesel", initial: "Pérdida de potencia, humo negro/blanco, arranque difícil.", modelosAplicables: ["Toyota Hilux 2.4L/2.8L"], alertaSeguridad: "No manipular inyectores con motor en marcha (alta presión).", symptoms: ["Pérdida potencia progresiva", "Humo negro (acelerar)", "Humo blanco (arranque frío)", "Consumo >12L/100km", "Arranque difícil frío", "Ralentí inestable"], causes: ["Inyectores obstruidos/desgastados", "Filtro combustible saturado", "Bomba alta presión (HP) defectuosa", "Sensor MAF sucio", "Válvula EGR carbonizada", "Turbo con juego excesivo", "Combustible contaminado"], diagnosticSteps: ["1. Escanear códigos OBD2.", "2. Verificar presión riel común (1350-1800 bar).", "3. Prueba retorno inyectores (<1.5L/min total).", "4. Medir resistencia inyectores (0.3-0.5 ohms).", "5. Verificar señal MAF (2.5-3.5V ralentí).", "6. Inspeccionar juego turbo (<0.05mm radial)."], solution: ["Limpieza/reemplazo inyectores", "Cambio filtro combustible", "Reemplazo bomba HP", "Limpieza MAF/EGR", "Reparación/reemplazo turbo", "Calibración con escáner Toyota"], costoEstimado: "US$ 100 (filtro) - US$ 3,000+ (inyectores/bomba)", searchTerms: "toyota hilux diesel inyector perdida potencia humo negro", codes: ["P0087", "P0093", "P0191", "P0201-P0204", "P2146"], datoIngeniero: "La presión Common Rail en Hilux es muy alta, cualquier contaminación afecta el rendimiento.", prevention: ["Cambio de combustible cada 6 meses si no se usa", "Usar aditivo limpiador cada 10,000 km", "Evitar quedarse sin combustible", "Calentar motor antes de exigir potencia máxima", "Cambiar filtro combustible cada 20,000 km"] },
        { id: 102, name: "Transmisión Automática", initial: "Cambios bruscos, deslizamiento, sobrecalentamiento.", modelosAplicables: ["Toyota Hilux (Automática)"], symptoms: ["Golpe al cambiar P->D o R", "Deslizamiento en subidas", "No entra marcha después de calentar", "Temperatura ATF >120°C", "Ruido zumbido"], causes: ["Nivel bajo ATF", "Filtro ATF obstruido", "Solenoides cambio defectuosos", "Clutch desgastado", "Módulo TCM fallando", "Enfriador ATF tapado"], diagnosticSteps: ["1. Verificar nivel ATF (motor caliente, neutro).", "2. Revisar color/olor ATF (rojo limpio vs café quemado).", "3. Medir temperatura con escáner.", "4. Prueba presión línea (10-12 bar).", "5. Escanear códigos TCM.", "6. Prueba stall (<2500 RPM)."], solution: ["Cambio ATF + filtro (usar Toyota ATF WS)", "Reemplazo solenoides", "Limpieza enfriador", "Overhaul si hay daño interno"], costoEstimado: "US$ 200 (cambio aceite) - US$ 4,000 (Overhaul)", searchTerms: "transmision automatica hilux cambios bruscos patina", codes: ["P0734", "P0750", "P0841", "P0715"], prevention:["Cambio ATF+filtro cada 60,000 km", "Usar exclusivamente Toyota ATF WS"] },
        { id: 110, name: "Chasis Fisurado (Zona Trasera)", initial:"Ruido ('clack') al pasar baches, posible desnivel.", modelosAplicables: ["Toyota Hilux"], alertaSeguridad:"Inspección estructural URGENTE. Riesgo de colapso.", symptoms:["Ruido estructural", "Desnivel caja carga", "Fisuras visibles cerca soportes ballestas"], causes:["Fatiga material por sobrecarga/torsión constante", "Corrosión"], diagnosticSteps:["1. Limpieza profunda chasis.", "2. Inspección visual detallada (especialmente sobre eje trasero).", "3. Prueba líquidos penetrantes si se sospecha fisura fina."], solution:["Reparación estructural por soldador calificado (seguir procedimiento fabricante)", "Instalar kit refuerzo chasis"], costoEstimado:"US$ 500 - $3,000+", searchTerms:"chasis fisurado hilux reparacion", codes:[], prevention:["No sobrecargar", "Inspección chasis cada 20,000 km"] }
    ],
    ranger: [
        { id: 201, name: "Enfriador EGR Fisurado (3.2L)", initial: "Pérdida de refrigerante, riesgo sobrecalentamiento.", modelosAplicables: ["Ford Ranger 3.2L"], alertaSeguridad: "Verificar nivel refrigerante. No operar si recalienta.", symptoms:["Baja nivel refrigerante sin fuga visible", "Humo blanco (si fuga es grande)", "Sobrecalentamiento"], causes:["Fisura interna enfriador EGR"], diagnosticSteps:["1. Prueba presión sistema enfriamiento.", "2. Verificar si hay refrigerante en admisión/escape.", "3. Desmontar e inspeccionar enfriador EGR."], solution:["Reemplazo del enfriador EGR"], costoEstimado:"US$ 400 - $800", searchTerms: "ford ranger 3.2 egr cooler leak perdida refrigerante", codes:["P0401", "P0402"] },
        { id: 107, name: "Inyectores con Fugas Internas (3.2L)", initial: "Arranque difícil, humo blanco, nivel aceite SUBE.", modelosAplicables: ["Ford Ranger 3.2L"], alertaSeguridad: "⚠️ Si nivel aceite sube, ¡NO ARRANCAR! Riesgo motor desbocado.", symptoms: ["Arranque difícil (especialmente caliente)", "Humo blanco excesivo", "Nivel aceite sube", "Aceite huele a diesel", "Ralentí inestable"], causes: ["Sellos internos inyector desgastados (Delphi)", "Alto kilometraje (+150k km)"], diagnosticSteps: ["1. ¡Verificar nivel y OLOR aceite!", "2. Prueba retorno inyectores.", "3. Escanear códigos.", "4. Análisis aceite (dilución)."], solution: ["Reemplazo URGENTE inyectores fugando", "Cambio aceite+filtro", "Usar inyectores Bosch (opcional, más fiables)"], costoEstimado: "US$ 400 - US$ 700 por inyector", searchTerms: "inyector ford ranger 3.2 fuga interna nivel aceite sube", codes: ["P0201-P0205", "P0267"], prevention:["Verificar nivel aceite frecuentemente", "Cambio filtro combustible según pauta"] }
    ],
    f150: [
        { id: 901, name: "Turbos EcoBoost - Enfriamiento", initial:"Pérdida potencia altas RPM, silbido agudo, humo.", modelosAplicables:["Ford F-150 Raptor 3.5L"], alertaSeguridad:"Riesgo daño turbo si sobrecalienta.", symptoms:["Pérdida potencia", "Silbido", "Humo blanco/azul", "Consumo aceite", "Sobrecalentamiento (arena)"], causes:["Intercooler obstruido (polvo)", "Wastegates carbonizadas", "Aceite incorrecto (Usar 5W-50)", "Juntas turbo", "Enfriamiento insuficiente"], diagnosticSteps:["1. Medir presión boost (1.8-2.0 bar).", "2. Verificar wastegates.", "3. Inspeccionar intercooler (aceite).", "4. Escanear códigos."], solution:["Limpieza intercooler", "Reemplazo juntas", "Actualizar software PCM", "Intercooler mejorado"], costoEstimado:"US$ 200 (limpieza) - $1,500+ (intercooler)", searchTerms:"ford f150 raptor ecoboost perdida potencia turbo", codes:["P0299", "P0234"], prevention:["Limpieza intercooler cada 20k km (minería)"], atacamaNotes:"Requiere intercooler de mayor capacidad para altitud y calor." }
    ],
    ram1500: [
        { id: 951, name: "Sistema EGR EcoDiesel", initial:"Pérdida potencia progresiva, consumo alto, regeneraciones DPF frecuentes.", modelosAplicables:["RAM 1500 3.0L Ecodiesel"], symptoms:["Pérdida potencia", "Consumo alto", "Regeneraciones DPF", "Humo gris"], causes:["Enfriador EGR obstruido", "Válvula EGR trabada", "Software"], diagnosticSteps:["1. Medir presión diferencial EGR.", "2. Medir temp. gases EGR.", "3. Analizar gases pre/post EGR.", "4. Escanear códigos."], solution:["Limpieza ultrasónica cooler EGR", "Reprogramación ECU", "Reemplazo válvula EGR", "EGR delete (solo off-road)"], costoEstimado:"US$ 300 (limpieza) - $1,000 (reemplazo)", searchTerms:"ram 1500 ecodiesel egr cooler falla", codes:["P0401", "P0404"], atacamaNotes:"La baja humedad y polvo fino pueden acelerar obstrucción. Limpieza preventiva cada 40k km." }
    ],
    komatsu_wb: [
        { id: 201, name: "Bomba Hidráulica Tándem", initial:"Movimientos lentos, cargador sin fuerza, ruido bomba.", modelosAplicables: ["WB93R-5", "WB97"], alertaSeguridad: "Alta presión hidráulica.", symptoms: ["Movimientos lentos (brazo/cargador)", "Ruido cavitación/chillido", "Temperatura aceite >85°C", "Espuma aceite"], causes: ["Desgaste interno bomba (A o B)", "Filtro succión colapsado", "Aceite incorrecto/viejo", "Aire en sistema", "Válvula alivio mal calibrada"], diagnosticSteps: ["1. Medir presiones (Implementos: 3135 PSI, Dirección: 2175 PSI).", "2. Verificar caudal (44 L/min c/u @ 2200 RPM).", "3. Medir temp. aceite.", "4. Inspeccionar filtro succión/retorno.", "5. Verificar nivel aceite."], solution: ["Overhaul/reemplazo bomba tándem", "Cambio aceite (Komatsu Genuine/ISO 46)", "Cambio filtro succión", "Calibrar válvulas", "Limpieza tanque", "Purgar aire"], costoEstimado: "US$ 3,000 (Overhaul) - US$ 9,000 (Nueva)", searchTerms: "komatsu wb93r bomba hidraulica lenta ruido", codes: ["E04"] }
    ],
    jd_retro: [
        { id: 2301, name: "Convertidor de Torque Slippage", initial:"RPM suben pero máquina no avanza o lo hace lentamente.", modelosAplicables:["John Deere 310SL/310L"], alertaSeguridad:"Sobrecalentamiento transmisión crítico.", symptoms:["RPM sube sin avance", "Temperatura transmisión >115°C", "Olor a aceite quemado", "Pérdida fuerza en pendiente"], causes:["Desgaste interno convertidor", "Baja presión clutch", "Filtro/refrigeración transmisión insuficiente", "Aceite bajo/quemado"], diagnosticSteps:["1. Prueba stall (No debe exceder 2200 RPM).", "2. Medir presión clutch/modulación.", "3. Análisis espectroscópico aceite transmisión.", "4. Verificar enfriador."], solution:["Overhaul/reemplazo convertidor de torque", "Upgrade kit refrigeración transmisión", "Cambio aceite (JD Hy-Gard) + filtro"], costoEstimado:"US$ 3,500 - $6,000 (Convertidor)", searchTerms:"john deere 310sl torque converter slippage patina", codes:[], prevention:["Análisis aceite cada 500h", "Cambio filtro cada 1000h"] }
    ],
     cat_retro: [
        { id: 203, name: "Bomba Hidráulica Pistones", initial:"Movimientos lentos, pérdida fuerza, ruido bomba.", modelosAplicables: ["416E", "420F", "430F", "446", "450"], symptoms: ["Lentitud general", "Sin fuerza excavación", "Ruido chillón/golpeteo", "Aceite caliente (>90°C)", "Espuma aceite"], causes: ["Desgaste interno bomba", "Filtro hidráulico saturado", "Aceite incorrecto/viejo (Usar HYDO Adv 10)", "Cavitación", "Válvula alivio mal calibrada", "Acople bomba-motor"], diagnosticSteps: ["1. Medir presión principal (3000-3600 PSI).", "2. Medir presión piloto (500-700 PSI).", "3. Verificar temp. aceite.", "4. Inspeccionar filtros (partículas metal).", "5. Prueba carga.", "6. Verificar RPM motor."], solution: ["Overhaul/reemplazo bomba", "Cambio aceite (CAT HYDO Adv 10) + filtros", "Limpieza tanque", "Purgar aire", "Calibrar válvula alivio"], costoEstimado: "US$ 3,000 (Overhaul) - US$ 10,000 (Nueva)", searchTerms: "caterpillar 416e 420f bomba hidraulica lenta ruido", codes: ["094-03", "100-03"], prevention:["Cambio aceite cada 2000h", "Filtros cada 500h", "Análisis aceite cada 1000h"] }
     ],
     hitachi_exc: [
        { id: 401, name: "Hydromaster Deriva Brazos", initial:"Brazos caen lentamente o pierden posición bajo carga.", modelosAplicables:["Hitachi ZX350/ZX470"], alertaSeguridad:"Riesgo de inestabilidad de implementos.", symptoms:["Brazos bajan lentamente", "Pérdida de posición bajo carga", "Sobrecalentamiento hidráulico", "Movimientos no comandados"], causes:["Válvulas de control con leakage (desgaste de spools)", "Sellos internos dañados", "Acumulación de presión residual"], diagnosticSteps:["1. Prueba de estanqueidad válvulas (Máximo 50 bar en 5 min).", "2. Termografía válvulas de control.", "3. Prueba de deriva en reposo."], solution:["Rectificado bancadas válvulas", "Kit sellos alta temperatura", "Actualización software control hidráulico"], costoEstimado:"US$ 5,000 - $15,000", searchTerms:"hitachi zx deriva brazos leakage hidromaster", codes:[] }
     ],
     doosan_exc: [
        { id: 402, name: "Motor Diesel - Problemas Inyección", initial:"Arranque difícil en frío, humo negro.", modelosAplicables:["Doosan DX300/DX500"], symptoms:["Arranque difícil frío", "Tirones al acelerar", "Humo negro intermitente", "Consumo elevado"], causes:["Inyectores fuera de calibración", "Sensor temp/presión faulty", "Presión riel inestable", "Bomba HP"], diagnosticSteps:["1. Analizar forma onda inyectores.", "2. Probar presión riel en tiempo real.", "3. Verificación sensores temperatura/presión."], solution:["Calibración dinámica inyectores", "Limpieza ultrasónica riel común", "Actualización firmware ECU"], costoEstimado:"US$ 500 - $3,000", searchTerms:"doosan dx hitachi zx inyeccion electronica falla humo negro", codes:[] }
     ],
     kawasaki_loader: [
        { id: 501, name: "Transmisión KES - Fallas Electrónicas", initial:"No cambia automáticamente, modo seguro, error display.", modelosAplicables:["Kawasaki 85Z/95Z"], symptoms:["Display error transmisión", "No cambia automáticamente", "Se queda en una marcha", "Modo seguro activado"], causes:["ECU transmisión (falla interna)", "Sensores velocidad (erráticos)", "Cableado/harness dañado", "Solenoides"], diagnosticSteps:["1. Escaneo profundo ECU transmisión.", "2. Verificación sensores velocidad.", "3. Prueba actuación solenoides."], solution:["Reprogramación completa KES", "Reemplazo harness transmisión", "Kit upgrade sensores velocidad", "Reemplazo ECU"], costoEstimado:"US$ 2,000 - $8,000", searchTerms:"kawasaki 85z transmision kes falla electronica", codes:[] }
     ],
     hyundai_loader: [
        { id: 502, name: "Dirección - Bomba Orbital Ruidosa", initial:"Dirección pesada a bajas RPM, ruido bomba, fugas.", modelosAplicables:["Hyundai HL850/HL960"], symptoms:["Dirección pesada bajas RPM", "Ruido bomba dirección", "Fugas crónicas en cilindros", "Volante con juego excesivo"], causes:["Bomba dirección dañada (desgaste)", "Cilindros con fugas", "Presión baja"], diagnosticSteps:["1. Medición presión sistema (180-220 bar).", "2. Análisis caudal bomba dirección.", "3. Inspección fugas cilindros."], solution:["Overhaul/reemplazo bomba dirección orbital", "Kit reparación cilindros dirección", "Actualización sistema de filtrado"], costoEstimado:"US$ 1,500 - $5,000", searchTerms:"hyundai hl850 direccion pesada ruido bomba orbital", codes:[] }
     ],
     belaz_dumper: [
        { id: 601, name: "Dirección Hidráulica Lenta", initial:"Dirección muy lenta, sobrecalentamiento, difícil maniobrar.", modelosAplicables:["BELAZ 7530/7560"], alertaSeguridad:"Pérdida de control direccional.", symptoms:["Dirección muy lenta", "Sobrecalentamiento crónico", "Fugas en cilindros principales", "Pérdida de control direccional"], causes:["Bomba dirección insuficiente", "Enfriamiento hidráulico insuficiente", "Fugas internas en válvulas/cilindros"], diagnosticSteps:["1. Medición tiempo respuesta dirección.", "2. Análisis térmico sistema completo.", "3. Prueba de carga máxima."], solution:["Kit upgrade bomba dirección", "Cilindros dirección reforzados", "Sistema enfriamiento adicional"], costoEstimado:"US$ 10,000 - $30,000+", searchTerms:"belaz direccion hidraulica lenta sobrecalentamiento", codes:[] }
     ],
     komatsu_dumper: [
        { id: 602, name: "Tracción Eléctrica AC - Pérdida Tracción", initial:"Alarmas eléctricas, sobrecalentamiento motores rueda, pérdida tracción.", modelosAplicables:["Komatsu 860E/930E"], alertaSeguridad:"Alta tensión.", symptoms:["Pérdida tracción intermitente", "Alarmas eléctricas múltiples", "Sobrecalentamiento motores rueda (>120°C)"], causes:["Módulos IGBT fatigados", "Armónicos en sistema (contaminación)", "Falla generador/inversor", "Cableado"], diagnosticSteps:["1. Análisis armónicos sistema eléctrico.", "2. Termografía componentes potencia.", "3. Prueba aislamiento motores/generador."], solution:["Reemplazo módulos IGBT", "Recalibración tracción", "Reparación/reemplazo generador/inversor"], costoEstimado:"US$ 10,000 (IGBT) - $400,000+ (Generador)", searchTerms:"komatsu 930e traccion electrica falla igbt", codes:[] }
     ],
    perforadora: [
        { id: 701, name: "Rotación Principal - Torque Insuficiente", initial:"Torque insuficiente en roca dura, vibraciones anormales.", modelosAplicables:["Perforadoras rotativas"], symptoms:["Torque insuficiente", "Vibraciones anormales", "Desgaste prematuro coronas", "Sobrecalentamiento motor rotación"], causes:["Motor rotación subdimensionado", "Desgaste coronas", "Falla hidráulica (presión/caudal bajo)"], diagnosticSteps:["1. Análisis espectro vibraciones.", "2. Medición torque real vs especificado.", "3. Inspección ultrasonido ejes."], solution:["Balanceo dinámico sistema rotación", "Kit upgrade motor rotación", "Reemplazo coronas"], costoEstimado:"Variable", searchTerms:"perforadora rotativa torque insuficiente vibracion", codes:[] }
    ],
    compactador: [
        { id: 801, name: "Sistema Vibratorio Hidráulico - Frecuencia Inestable", initial:"Frecuencia inestable, amplitud decreciente, ruidos metálicos.", modelosAplicables:["Compactadores vibratorios"], symptoms:["Frecuencia variable", "Ruidos metálicos", "Amplitud decreciente", "Fugas aceite en motovibradores"], causes:["Ejes excéntricos desbalanceados", "Fugas internas/externas", "Falla control hidráulico (válvulas)"], diagnosticSteps:["1. Analisis frecuencia/amplitud real.", "2. Medición presión sistema vibratorio.", "3. Inspección ejes excéntricos."], solution:["Rebalanceo masas excéntricas", "Kit sellos motovibradores", "Actualización control vibratorio"], costoEstimado:"US$ 1,500 - $5,000", searchTerms:"compactador vibratorio frecuencia inestable", codes:[] }
    ],
    diagnostico: [
        { id: 8001, name: "Análisis de Vibraciones (Rodamientos/Engranajes)", initial:"Detección de fatiga/desbalance/desalineación.", modelosAplicables:["Diagnóstico Avanzado"], symptoms:["Aumento velocidad vibratoria RMS", "Bandas laterales engranajes", "Frecuencias características rodamientos (BPFO, BPFI)"], causes:["Desbalanceo", "Desalineación", "Fatiga rodamientos", "Desgaste engranajes"], diagnosticSteps:["1. Adquisición acelerómetros 10kHz.", "2. Análisis espectral (FFT).", "3. Tendencias de velocidad/aceleración."], solution:["Balanceo dinámico", "Alineación láser", "Reemplazo rodamientos/engranajes"], costoEstimado:"N/A (Metodología)", searchTerms:"analisis vibraciones rodamientos engranajes", codes:[], diagnosticTechnique:{ description: "Metodología de Análisis Espectral Cuantitativo:", code: `Acelerómetros triaxiales, muestreo >=10kHz, análisis espectral.\nLímites: < 2.8 mm/s - Bueno; > 7.1 mm/s - No satisfactorio (ISO 10816-3).\nFrecuencias típicas: BPFO, BPFI, FTF, BSF. Consultar tablas de rodamientos.`}, specs: { iso:"ISO 10816-3", freq_sampling: ">= 10 kHz" } },
        { id: 8002, name: "Termografía Infrarroja (Hotspots)", initial:"Detección de sobrecalentamiento en componentes.", modelosAplicables:["Diagnóstico Avanzado"], symptoms:["Puntos calientes (Hotspots) detectables IR"], causes:["Conexiones eléctricas flojas", "Desbalanceo de fases", "Falla incipiente en rodamientos", "Válvulas hidráulicas obstruidas"], diagnosticSteps:["1. Escaneo termografico (comparar con baseline).", "2. Medición de gradientes de temperatura.", "3. Inspección visual del componente."], solution:["Apretar conexiones", "Equilibrar fases", "Reemplazar rodamientos", "Limpieza/Reemplazo válvulas"], costoEstimado:"N/A (Metodología)", searchTerms:"termografia infrarroja diagnostico hotspots", codes:[], diagnosticTechnique:{ description: "Criterios de Alarma (Delta T):", code:`Diferencia de temperatura > 15°C respecto a componentes similares o baseline es crítica.\nUsar análisis termográfico comparativo (Delta T) y absoluto.`} },
        { id: 9001, name: "Análisis de Aceite (Tribología)", initial:"Partículas de desgaste elevadas, contaminación, degradación.", modelosAplicables:["Diagnóstico Avanzado"], symptoms:["Aumento Fe, Si, Al, Cr en ppm", "Viscosidad fuera de rango", "Alto Número Ácido (TAN)", "Presencia Agua/Combustible"], causes:["Desgaste rodamientos/engranajes", "Contaminación abrasiva (Si/Al)", "Contaminación por agua/combustible", "Oxidación/degradación aditivos"], diagnosticSteps:["1. Espectrometría de emisión atómica (ICP/OES).", "2. Viscosidad cinemática (40°C/100°C).", "3. Número Ácido Total (TAN) / Número Básico Total (TBN).", "4. Ferrografía Analítica (morfología partículas).", "5. Conteo de partículas (ISO 4406)."], solution:["Filtrado avanzado (riñón)", "Cambio aceite", "Investigación origen partículas", "Reemplazo filtros", "Reparación sellos"], costoEstimado:"N/A (Metodología)", searchTerms:"analisis aceite ppm desgaste contaminacion ferrografia", codes:[], diagnosticTechnique:{ description: "Límites de Alarma Típicos (ppm) y Estándares:", code:`Límites críticos (ppm) varían por compartimento: Fe > 50-200 (motor), Si > 20 (alerta contaminación).\nClasificación ISO 4406 limpieza (Objetivo: 18/16/13 o menor para hidráulico).\nVerificar si la dilución por combustible es mayor al 2%.`} }
    ]
    // ... (El resto de la base de datos 'failures' completa)
};

// --- BASE DE DATOS 4: BIBLIOTECA (De Don_Piston_Proyecto.txt) ---
const db_videos = [
    { title: "Formación de Técnico de Maquinaria Pesada", url: "https://www.youtube.com/embed/BDOqZ2tT5Fs", desc: "Explica lo que implica aprender el oficio de mecánico de maquinaria pesada.", img: "https://img.youtube.com/vi/BDOqZ2tT5Fs/0.jpg" },
    { title: "Reparaciones Reales en Campo (Service Call #61)", url: "https://www.youtube.com/embed/i-rOPrysBkM", desc: "Reparaciones reales en campo, con excavadoras, ejes rotos, etc.", img: "https://img.youtube.com/vi/i-rOPrysBkM/0.jpg" },
    { title: "Tips y Trucos para Reparación", url: "https://www.youtube.com/embed/8WC3tr1Lo-U", desc: "Consejos de mantenimiento general para maquinaria pesada.", img: "https://img.youtube.com/vi/8WC3tr1Lo-U/0.jpg" },
    { title: "Tutorial: Engrase y Aceitado de Maquinaria", url: "https://www.youtube.com/embed/o7cCcDcTurs", desc: "Mantenimiento básico: engrase, engrasadores, etc.", img: "https://img.youtube.com/vi/o7cCcDcTurs/0.jpg" },
    { title: "Guía de Primeras Herramientas (Mecánico Pesado)", url: "https://www.youtube.com/embed/zerPj6JX2fY", desc: "Ideal para estudiantes o gente que está empezando.", img: "https://img.youtube.com/vi/zerPj6JX2fY/0.jpg" },
    { title: "Servicio de Excavadora de 250 Horas", url: "https://www.youtube.com/embed/QNzaDCCyTGE", desc: "Un servicio de excavadora de 250 horas, bastante especializado.", img: "https://img.youtube.com/vi/QNzaDCCyTGE/0.jpg" },
    { title: "Reparación Cilindros CAT 992K Gigante", url: "https://www.youtube.com/embed/bl3WwrUTB8M", desc: "Reparación avanzada de cilindros hidráulicos en maquinaria gigante.", img: "https://img.youtube.com/vi/bl3WwrUTB8M/0.jpg" },
    { title: "Reparaciones en la Lluvia (Service Call #68)", url: "https://www.youtube.com/embed/C7hloLZ1KT0", desc: "Muestra la realidad del trabajo de campo bajo condiciones duras (lluvia, barro).", img: "https://img.youtube.com/vi/C7hloLZ1KT0/0.jpg" }
];

const db_foros = [
    { title: "¿Cómo entraste al mundo de la maquinaria pesada?", url: "https://www.reddit.com/r/heavyequipment/comments/1dxbqdd/how_did_you_get_into_heavy_equipment/", desc: "Un mecánico comenta su transición al rubro." },
    { title: "¿Quién hace el Mantenimiento Diario?", url: "https://www.reddit.com/r/heavyequipment/comments/1k1pkhn/a_question_on_who_does_the_daily_maintenance_on/", desc: "Útil para ver tareas reales de mantenimiento diario." },
    { title: "Técnico Diésel vs. Maquinaria Pesada", url: "https://www.reddit.com/r/DieselTechs/comments/142jxi5/diesel_tech_vs_heavy_equipment/", desc: "Comparación entre mecánica diésel y maquinaria pesada." },
    { title: "¿Vale la pena ser técnico de maquinaria pesada?", url: "https://www.reddit.com/r/heavyequipment/comments/z6ezoi/is_it_worth_being_a_heavy_equipment_technician/", desc: "La parte de estilo de vida/trabajo duro." },
    { title: "Experiencias de campo", url: "https://www.reddit.com/r/DieselTechs/comments/1bci2dl/heavy_equipment_mechanic/", desc: "Historias reales y consejos de veteranos." },
    { title: "Foro Principal: HeavyEquipmentForums", url: "https://www.heavyequipmentforums.com", desc: "La comunidad técnica más grande, con miles de hilos para mecánicos." }
];


/* ========================================================================= */
/* LÓGICA DE LA APLICACIÓN (v2.0)                                            */
/* ========================================================================= */

// --- Variables Globales ---
let allFailuresFlat = []; // Lista plana de todas las fallas del manual
let selectedMachineType = null;
let selectedBrandModelKey = null;
const allTabButtons = document.querySelectorAll('.tab-button');
const allTabContents = document.querySelectorAll('.tab-content');

// --- Funciones Principales ---

document.addEventListener('DOMContentLoaded', () => {
    // 1. Inicializar Pestañas
    setupTabs();
    
    // 2. Inicializar Chatbot
    setupChatbot();
    
    // 3. Inicializar Manual
    allFailuresFlat = flattenData(failures); // Crear la lista plana para el chatbot
    setupManual();
    
    // 4. Inicializar Biblioteca
    setupBiblioteca();
});

function setupTabs() {
    allTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.dataset.tab;
            activateTab(tabName);
        });
    });
}

function activateTab(tabName) {
    allTabButtons.forEach(btn => btn.classList.remove('active'));
    allTabContents.forEach(content => content.classList.remove('active'));

    document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

function setupChatbot() {
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-input-form');
    const chatInput = document.getElementById('chat-input');

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userQuery = chatInput.value.trim();
        if (userQuery === "") return;

        appendMessage('user', userQuery);
        chatInput.value = "";

        setTimeout(() => {
            const botResponse = findBotResponse(userQuery);
            appendMessage('bot', botResponse);
        }, 500);
    });
}

function appendMessage(sender, text) {
    const chatLog = document.getElementById('chat-log');
    const icon = sender === 'bot' ? 'B' : '<i class="fas fa-user"></i>';
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.innerHTML = `
        <div class="icon">${icon}</div>
        <div class="text-bubble">${text}</div>
    `;
    chatLog.appendChild(messageDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
}

/**
 * LÓGICA DE BÚSQUEDA INTELIGENTE v2.0
 */
function findBotResponse(query) {
    const lowerQuery = query.toLowerCase();
    
    const frasesIntro = [
        "Mire, compadre, eso me suena a...",
        "A ver, parcero, déjeme pensar...",
        "Clásico problema, viejo. Lo que pasa es que...",
        "Echale ojo a esto que te voy a decir...",
        "Uy, esa falla es complicada pero tiene maña..."
    ];
    const frasesFallo = [
        "Me corchaste, mijo. Mejor revisa el manual técnico.",
        "Ni idea, parcero. ¿Ya revisaste si tiene gasolina? Je, je. Ahora en serio, mejor busca en Google o en el manual.",
        "Uf, de eso sí que no me acuerdo bien. Prueba buscando en el Manual del Taller."
    ];

    // --- Búsqueda 1: "Taller Real" (Conversacional) ---
    let bestMatch = null;
    let maxMatchCount = 0;
    for (const item of db_preguntas_respuestas) {
        let matchCount = 0;
        for (const keyword of item.keywords) {
            if (lowerQuery.includes(keyword)) {
                matchCount++;
            }
        }
        if (matchCount > maxMatchCount) {
            maxMatchCount = matchCount;
            bestMatch = item.respuesta;
        }
    }

    if (maxMatchCount > 1) { // Requiere al menos 2 palabras clave
        const randomIntro = frasesIntro[Math.floor(Math.random() * frasesIntro.length)];
        return `${randomIntro}<br><br><strong>${bestMatch}</strong>`;
    }

    // --- Búsqueda 2: Escenarios Generales (Como "motor con agua") ---
    const scenario = handleGeneralScenarioQuery(lowerQuery, "esta máquina");
    if (scenario) {
        let html = `¡Ojo con eso, parcero! Cuando entra agua al motor, la cosa es grave. A eso le llamamos <strong>${scenario.name}</strong>.<br><br>`;
        html += `<strong>Síntomas (lo que se ve):</strong><ul>`;
        scenario.symptoms.forEach(s => html += `<li>${s}</li>`);
        html += `</ul><br><strong>Causas probables (por qué pasó):</strong><ul>`;
        scenario.causes.forEach(c => html += `<li>${c}</li>`);
        html += `</ul><br><strong>Solución (lo que hay que hacer):</strong><ul>`;
        scenario.solution.forEach(s => html += `<li>${s}</li>`);
        html += `</ul><br><strong style="color: ${'var(--color-rojo)'};">${scenario.alertaSeguridad}</strong>`;
        return html;
    }

    // --- Búsqueda 3: El Manual Técnico (la base de datos grande) ---
    const manualResults = allFailuresFlat.filter(f => {
        // Buscar en nombre, síntomas, códigos y términos de búsqueda
        const searchableText = [f.name, f.initial, f.searchTerms, ...(f.symptoms || []), ...(f.codes || [])]
            .filter(item => typeof item === 'string').join(' ').toLowerCase();
        
        // Verificar si *algún* término de la búsqueda (de más de 2 letras) está en el texto
        return lowerQuery.split(' ').filter(t => t.length > 2).some(term => searchableText.includes(term));
    });

    if (manualResults.length > 0) {
        const firstResult = manualResults[0];
        return `Me corchaste con un cuento exacto de eso, pero...<br><br>
                En <strong>El Manual del Taller</strong> (la otra pestaña) tengo información técnica sobre <strong>"${firstResult.name}"</strong>.
                Eso suena a lo que buscas.<br><br>
                <button class="search-btn" onclick="openManualEntry('${firstResult._sourceKey}', ${firstResult.id})">
                    <i class="fas fa-book-open"></i> Ver en el Manual
                </button>`;
    }

    // --- Búsqueda 4: Fallback ---
    const randomFallback = frasesFallo[Math.floor(Math.random() * frasesFallo.length)];
    return randomFallback;
}

// Función auxiliar para Búsqueda 2
function handleGeneralScenarioQuery(query, machineName) {
    let scenarioKey = null;
    if (query.includes('agua') && (query.includes('motor') || query.includes('aceite'))) scenarioKey = "motor_con_agua";
    // (Añadir más escenarios como 'motor_sin_aceite' aquí)

    if (scenarioKey && generalScenarioTemplates[scenarioKey]) {
        const templateFunction = generalScenarioTemplates[scenarioKey];
        return { ...templateFunction(machineName), _isGenerated: true };
    }
    return null;
}

// Función auxiliar para Búsqueda 3
function flattenData(data) {
    const flatList = [];
    for (const key in data) {
        if (Array.isArray(data[key])) {
            data[key].forEach(item => {
                if (item && typeof item === 'object') {
                    flatList.push({ ...item, _sourceKey: key });
                }
            });
        }
    }
    return flatList;
}

/**
 * Función global para que el botón del chat abra el manual
 */
function openManualEntry(brandKey, failureId) {
    const failure = (failures[brandKey] || []).find(f => f.id === failureId);
    if (!failure) return;

    // 1. Activar la pestaña del manual
    activateTab('manual');

    // 2. Encontrar la marca y el tipo de máquina (esto es un poco inverso)
    let typeKey = null;
    for (const key in brandsAndModels) {
        if (brandsAndModels[key].some(brand => brand.key === brandKey)) {
            typeKey = key;
            break;
        }
    }
    
    // 3. Simular la navegación del manual
    const manualWindow = document.getElementById('manual-window');
    if (typeKey) {
        showBrands(typeKey);
    } else {
        // Si no se encuentra tipo (ej. diagnóstico avanzado), solo mostrar la falla
        initMachineTypes(); // Asegurarse que el paso 1 esté visible
    }
    
    selectBrandModel(brandKey);
    showDiagnosis(failure);
    
    // 4. Scroll hasta el diagnóstico
    setTimeout(() => {
        manualWindow.querySelector('#diagnosisArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}


// --- Lógica del Manual (Basada en gemini.txt) ---
function setupManual() {
    const manualWindow = document.getElementById('manual-window');
    const machineTypeSection = manualWindow.querySelector('#machineTypeSection');
    const brandModelSection = manualWindow.querySelector('#brandModelSection');
    const failureSection = manualWindow.querySelector('#failureSection');
    const diagnosisArea = manualWindow.querySelector('#diagnosisArea');
    const machineTypesGrid = manualWindow.querySelector('#machineTypesGrid');
    const brandsGrid = manualWindow.querySelector('#brandsGrid');
    const failuresList = manualWindow.querySelector('#failuresList');
    const filterInput = manualWindow.querySelector('#filterInput');
    const diagnosisResult = manualWindow.querySelector('#diagnosisResult');
    const diagnosisTitle = manualWindow.querySelector('#diagnosisTitle');
    const backToTypesBtn = manualWindow.querySelector('#backToTypesBtn');
    const backToBrandsBtn = manualWindow.querySelector('#backToBrandsBtn');
    const backToFailuresBtn = manualWindow.querySelector('#backToFailuresBtn');
    const btnOpenGoogleDiag = manualWindow.querySelector('#btnOpenGoogleDiag');
    const btnReset = manualWindow.querySelector('#btnReset');

    function renderManualIcon(iconHtmlOrEmoji) {
        if (typeof iconHtmlOrEmoji === 'string' && iconHtmlOrEmoji.startsWith('<i')) {
            return iconHtmlOrEmoji;
        }
        return `<span class="icon">${iconHtmlOrEmoji || '❓'}</span>`;
    }

    function initMachineTypes() {
        machineTypesGrid.innerHTML = '';
        Object.keys(machineTypes).sort((a,b) => machineTypes[a].name.localeCompare(machineTypes[b].name)).forEach(key => {
            const type = machineTypes[key];
            const card = document.createElement('div');
            card.className = 'selection-card';
            card.innerHTML = `${renderManualIcon(type.icon)}<strong>${type.name}</strong><div class="description">${type.description || ''}</div>`;
            card.onclick = () => showBrands(key);
            machineTypesGrid.appendChild(card);
        });
    }
    window.showBrands = function(typeKey) { // Hacer global para openManualEntry
        selectedMachineType = typeKey;
        brandsGrid.innerHTML = '';
        const brands = brandsAndModels[typeKey] || [];
        if (brands.length === 0) {
            brandsGrid.innerHTML = `<p class="no-failures">Aún no hay marcas/modelos definidos para ${machineTypes[typeKey]?.name || typeKey}.</p>`;
        } else {
            brands.sort((a,b) => a.name.localeCompare(b.name)).forEach(brand => {
                const card = document.createElement('div');
                card.className = 'selection-card';
                const modelsText = (brand.models && Array.isArray(brand.models)) ? `<div class="description">${brand.models.join(' / ')}</div>` : '';
                card.innerHTML = `${renderManualIcon(brand.icon || machineTypes[typeKey]?.icon)}<strong>${brand.name}</strong>${modelsText}`;
                card.onclick = () => selectBrandModel(brand.key);
                brandsGrid.appendChild(card);
            });
        }
        machineTypeSection.classList.add('hidden');
        brandModelSection.classList.remove('hidden');
        failureSection.classList.add('hidden');
        diagnosisArea.classList.add('hidden');
    }

    window.selectBrandModel = function(brandKey) { // Hacer global
        selectedBrandModelKey = brandKey;
        filterInput.value = '';
        renderFailuresList(brandKey, '');
        brandModelSection.classList.add('hidden');
        failureSection.classList.remove('hidden');
        diagnosisArea.classList.add('hidden');
    }

    function renderFailuresList(brandKey, filterText = '') {
        failuresList.innerHTML = '';
        const modelFailures = Array.isArray(failures[brandKey]) ? failures[brandKey] : [];
        const lowerFilterText = filterText.toLowerCase().trim();
        
        const filteredFailures = modelFailures.filter(f => {
            if (!f || typeof f !== 'object') return false;
            if (!lowerFilterText) return true;
            const searchableText = [
                f.name, f.initial, f.searchTerms,
                ...(f.symptoms || []), ...(f.modelosAplicables || []), ...(f.codes || []),
                ...(f.causes || []), ...(f.solution || []), ...(f.prevention || []), f.datoIngeniero,
            ].filter(item => typeof item === 'string').join(' ').toLowerCase();
            return searchableText.includes(lowerFilterText);
        });

        if (filteredFailures.length === 0) {
            let brandName = 'este modelo/método';
            const brandData = (brandsAndModels[selectedMachineType] || []).find(b => b.key === brandKey);
            if (brandData) brandName = brandData.name;
            failuresList.innerHTML = `<p class="no-failures">${filterText ?
                'No se encontraron fallas con ese filtro.' : `Aún no hay fallas definidas para ${brandName}.`}</p>`;
        } else {
            filteredFailures.sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'failure-btn';
                const modelsText = (f.modelosAplicables && Array.isArray(f.modelosAplicables)) ? `<div class="models">Modelos: ${f.modelosAplicables.join(', ')}</div>` : '';
                const initialText = f.initial || 'Contexto no especificado.';
                btn.innerHTML = `<strong>${f.name || 'Falla sin nombre'}</strong><div class="initial-context">${initialText}</div>${modelsText}`;
                btn.onclick = () => showDiagnosis(f);
                failuresList.appendChild(btn);
            });
        }
    }

    filterInput.addEventListener('input', (e) => {
        if (selectedBrandModelKey) {
            renderFailuresList(selectedBrandModelKey, e.target.value);
        }
    });

    const renderList = (items, type = 'ul') => {
        if (!items || (Array.isArray(items) && items.length === 0)) return '<p>Información no disponible.</p>';
        if (typeof items === 'string') return `<p>${items}</p>`;
        if (Array.isArray(items)) {
            const listItems = items.filter(item => item != null && String(item).trim() !== '').map(item => `<li>${String(item)}</li>`).join('');
            if (!listItems) return '<p>Información no disponible.</p>';
            return type === 'ol' ? `<ol>${listItems}</ol>` : `<ul>${listItems}</ul>`;
        }
        return '<p>Formato de datos no reconocido.</p>';
    };
    const renderCodes = (codes) => {
        if (!Array.isArray(codes) || codes.length === 0) return '';
        const codeItems = codes.filter(c => c != null && String(c).trim() !== '').map(c => `<code>${String(c)}</code>`).join(' ');
         if (!codeItems) return '';
        return `<div class="info-card codes-list"><h4><i class="fas fa-laptop-code"></i> Códigos Error Comunes</h4><p>${codeItems}</p></div>`;
    };
    const renderAdvanced = (items) => {
        if (!items) return '';
        let content = '';
        if (typeof items === 'string') { content = `<p>${items}</p>`; }
        else if (Array.isArray(items) && items.length > 0) { content = renderList(items, 'ol'); }
        else if (typeof items === 'object' && items !== null && items.code !== undefined) { content = `${items.description ? `<p>${items.description}</p>` : ''}<pre><code>${items.code}</code></pre>`; }
        else { return ''; }
        return `<div class="info-card advanced-card"><h4><i class="fas fa-microscope"></i> Diagnóstico Avanzado / Técnico</h4>${content}</div>`;
    };
    const renderSpecs = (specs) => {
         if (!specs) return '';
         let content = '';
         if(typeof specs === 'string') { content = `<p>${specs}</p>`; }
         else if (Array.isArray(specs) && specs.length > 0) { content = renderList(specs); }
         else if (typeof specs === 'object' && specs !== null && Object.keys(specs).length > 0) {
             content = '<ul>';
             for (const key in specs) {
                 const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace(/_/g, ' ');
                 content += `<li><strong>${formattedKey}:</strong> ${specs[key]}</li>`;
             }
             content += '</ul>';
         }
         if (!content || content === '<ul></ul>') return '';
         return `<div class="info-card specs-card"><h4><i class="fas fa-ruler-combined"></i> Especificaciones Técnicas</h4>${content}</div>`;
    };
    const renderAtacama = (notes) => {
        if (!notes) return '';
         return `<div class="info-card atacama-note"><h4><i class="fas fa-mountain-sun"></i> Notas Específicas Atacama</h4>${renderList(notes)}</div>`;
    }

    window.showDiagnosis = function(f) { // Hacer global
        if (!f || typeof f !== 'object') return;
        diagnosisArea.classList.remove('hidden');
        failureSection.classList.add('hidden');
        diagnosisTitle.innerHTML = `<i class="fas fa-clipboard-list section-icon"></i> Diagnóstico: ${f.name || 'Detalle de Falla'}`;
        diagnosisResult.innerHTML = `
            ${(f.modelosAplicables && Array.isArray(f.modelosAplicables)) ?
            `<p class="model-info">Modelos: ${f.modelosAplicables.join(', ')}</p>`: ''}
            ${f.alertaSeguridad ? `<div class="alert-safety info-card"><h4><i class="fas fa-triangle-exclamation"></i> ALERTA SEGURIDAD</h4><p>${f.alertaSeguridad || 'N/A'}</p></div>` : ''}
            <div class="info-card"><h4><i class="fas fa-eye"></i> Síntomas</h4>${renderList(f.symptoms)}<p style="margin-top:15px;"><strong>Contexto:</strong> ${f.initial || 'N/A'}</p></div>
            <div class="info-card"><h4><i class="fas fa-project-diagram"></i> Causas Probables</h4>${renderList(f.causes)}</div>
            <div class="info-card"><h4><i class="fas fa-stethoscope"></i> Pasos de Diagnóstico</h4>${renderList(f.diagnosticSteps, 'ol')}</div>
            ${renderAdvanced(f.diagnosticAdvanced || f.diagnosticTechnique)}
            <div class="info-card"><h4><i class="fas fa-wrench"></i> Soluciones Recomendadas</h4>${renderList(f.solution)}</div>
            ${renderAdvanced(f.solutionAdvanced)}
            <div class="info-card gestion-card"><h4><i class="fas fa-tasks"></i> Gestión (Estimados)</h4><p><strong>Costo Estimado:</strong> ${f.costoEstimado || 'Variable'}</p>${f.tiempoDowntime ? `<p><strong>Tiempo Inactividad (Downtime):</strong> ${f.tiempoDowntime}</p>` : ''}</div>
            ${renderSpecs(f.specs)}
            ${renderCodes(f.codes)}
            ${renderAtacama(f.atacamaNotes)}
            ${f.datoIngeniero || f.prevention ? `<div class="info-card alert-engineer"><h4><i class="fas ${f.prevention ? 'fa-shield-alt' : 'fa-lightbulb'}"></i> ${f.prevention ? 'Prevención' : 'Dato Técnico'}</h4>${f.datoIngeniero ? `<p>${f.datoIngeniero}</p>` : ''}${f.prevention ? renderList(f.prevention) : ''}</div>` : ''}
        `;
        const searchTerm = (typeof f.searchTerms === 'string' ? f.searchTerms : f.name) || '';
        const q = encodeURIComponent(searchTerm);
        let brandModelName = '';
        if (selectedMachineType && selectedBrandModelKey) {
            const brandData = (brandsAndModels[selectedMachineType] || []).find(b => b.key === selectedBrandModelKey);
            brandModelName = brandData ? brandData.name : '';
        }
        btnOpenGoogleDiag.href = `https://www.google.com/search?q=${q}+${encodeURIComponent(brandModelName)}`;
    }
    
    // Listeners de botones del Manual
    backToTypesBtn.addEventListener('click', () => {
        brandModelSection.classList.add('hidden');
        machineTypeSection.classList.remove('hidden');
        selectedBrandModelKey = null;
    });
    backToBrandsBtn.addEventListener('click', () => {
        failureSection.classList.add('hidden');
        brandModelSection.classList.remove('hidden');
    });
    backToFailuresBtn.addEventListener('click', () => {
        diagnosisArea.classList.add('hidden');
        failureSection.classList.remove('hidden');
    });
    btnReset.addEventListener('click', () => {
        brandModelSection.classList.add('hidden');
        failureSection.classList.add('hidden');
        diagnosisArea.classList.add('hidden');
        machineTypeSection.classList.remove('hidden');
        selectedMachineType = null;
        selectedBrandModelKey = null;
        filterInput.value = '';
        window.scrollTo({top: 0, behavior:'smooth'});
    });
    
    // Iniciar el Manual
    initMachineTypes();
}

    // --- Lógica de la Biblioteca ---
function setupBiblioteca() {
    const videoList = document.getElementById('video-list');
    const forumList = document.getElementById('forum-list');

    db_videos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        card.innerHTML = `
            <a href="${video.url.replace('embed/', 'watch?v=')}" target="_blank" rel="noopener noreferrer">
                <img src="${video.img}" alt="${video.title}">
            </a>
            <div class="resource-card-content">
                <h4>${video.title}</h4>
                <p>${video.desc}</p>
                <a href="${video.url.replace('embed/', 'watch?v=')}" target="_blank" rel="noopener noreferrer">Ver Video <i class="fas fa-external-link-alt"></i></a>
            </div>
        `;
        videoList.appendChild(card);
    });

    db_foros.forEach(forum => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        card.innerHTML = `
            <div class="resource-card-content">
                <h4>${forum.title}</h4>
                <p>${forum.desc}</p>
                <a href="${forum.url}" target="_blank" rel="noopener noreferrer">Leer Hilo <i class="fas fa-external-link-alt"></i></a>
            </div>
        `;
        forumList.appendChild(card);
    });
}
});
</script>
</body>
</html>
